name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    name: Test on iOS ${{ matrix.ios }}
    runs-on: macos-14
    strategy:
      matrix:
        ios: ['17.0', '16.0', '15.0']
        include:
          - ios: '17.0'
            device: 'iPhone 15'
          - ios: '16.0'
            device: 'iPhone 14'
          - ios: '15.0'
            device: 'iPhone 13'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_15.2.app

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Run tests
      run: |
        xcodebuild test \
          -scheme LinkFortySDK \
          -destination "platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.ios }}" \
          -enableCodeCoverage YES \
          | xcpretty

    - name: Upload coverage to Codecov
      if: matrix.ios == '17.0'
      uses: codecov/codecov-action@v3
      with:
        file: ./build/CodeCoverage/LinkFortySDK.xcresult
        flags: unittests
        fail_ci_if_error: false

  lint:
    name: SwiftLint
    runs-on: macos-14
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: swiftlint lint --strict

  spm:
    name: SPM Build
    runs-on: macos-14
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build with SPM
      run: swift build -v
